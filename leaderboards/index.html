<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phantom Spark Leaderboards</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <h1>
        <div id="table-title"></div>
    </h1>
    <div id="links-container">
        <ul id="link-list"></ul>
    </div>
    <div id="table-container"></div>
    
    <script>
        // If this becomes a drag, there's a file called "tracklist" on the blob storage that gets generated as well
        // so you could read that in...
        const links = [
        
                { label: 'DEMO P1.1 - Stone', param: 'Mass_V2_DEMO' }, 
                { label: 'DEMO P1.2 - Smoke', param: 'Wings_V2_DEMO' }, 
                { label: 'DEMO P1.3 - Magma', param: 'Dream_V2_DEMO' }, 
                { label: 'TOTAL SCORE', param: 'total_DEMO' }
            ];


        async function displayCSV(url) {
            try {
                const response = await fetch(url);
                const csvData = await response.text();
                const rows = csvData.split("\n");
                let html = "<table>";

                for (let i = 0; i < rows.length; i++) {
                    html += "<tr>";
                    const cells = rows[i].split(",");
                    for (let j = 0; j < cells.length; j++) {

                        if (j === 1) {
                            const timeInSeconds = parseInt(cells[j]) / 1000;
                            const hours = Math.floor(timeInSeconds / 3600);
                            const minutes = Math.floor((timeInSeconds % 3600) / 60);
                            const seconds = (timeInSeconds % 60).toFixed(3);
                            let formattedTime = '';

                            if (hours > 0) {
                                formattedTime += `${hours}h `;
                            }
                            if (minutes > 0 || hours > 0) {
                                formattedTime += `${minutes}m `;
                            }
                            formattedTime += `${seconds.toString().padStart(6,"0")}`;

                            html += `<td>${formattedTime}</td>`;
                        }
                        else if (j === 2) {
                            html += `<td><img class="flag" src="flags/${cells[j].toLowerCase()}.png" /></td>`;
                        }
                        else {
                            html += `<td>${cells[j]}</td>`;
                        }
                    }
                    html += "</tr>";
                }


                html += "</table>";

                document.getElementById("table-container").innerHTML = html;
            } catch (error) {
                console.error("Error fetching CSV:", error);
            }
        }

        function createLinkList() {
            const linkList = document.getElementById('link-list');


            for (let i = 0; i < links.length; i += 1) {

                const link = links[i];

                const listItem = document.createElement('li');
                let html = "<a href='?track=" + links[i].param + "&label=" + link.label + "'>" + link.label + "</a>&emsp;";
                // if(i < links.length - 1)
                //     html += "<a href='?track=" + links[i].param + "_admin&label=" + link.label + "'>(admin)</a>&emsp;";

                listItem.innerHTML = html;
                linkList.appendChild(listItem);
            }

            
        }

        createLinkList();

        const urlParams = new URLSearchParams(window.location.search);
        
        let trackParam = urlParams.get('track');
        let labelParam = urlParams.get('label');

        if(trackParam == null) // auto select first
        {
            trackParam = links[0].param;
            labelParam = links[0].label;
        }

        document.getElementById("table-title").innerHTML = labelParam;

        const csvURL = "https://gliderushfunctions.blob.core.windows.net/webview/" + trackParam;

        // Display the CSV as HTML table
        displayCSV(csvURL);




    </script>
</body>

</html>